{
  "title": "Disaster Recovery Failover",
  "id": "dr-failover",
  "service": "Infra",
  "category": "Critical",
  "tags": ["dr", "failover", "critical", "database"],
  "shortDescription": "Procedure to failover primary region to secondary.",
  "fullDescription": "Emergency steps to redirect traffic and promote secondary database replica in case of primary region failure.",
  "type": "qrun",
  "steps": [
    {
      "title": "Confirm Outage",
      "content": [
        { "type": "text", "text": "Verify primary region is unreachable via independent monitoring." },
        { "type": "code", "language": "bash", "code": "curl -I https://status.aws.amazon.com" }
      ]
    },
    {
      "title": "Declare Disaster",
      "content": [
        { "type": "text", "text": "Notify stakeholders and open critical incident bridge." }
      ]
    },
    {
      "title": "Stop Traffic to Primary (If possible)",
      "content": [
        { "type": "text", "text": "Prevent split-brain by ensuring primary is truly offline or fenced." }
      ]
    },
    {
      "title": "Promote Read Replica",
      "content": [
        { "type": "text", "text": "Promote the DR region database to standalone (Read/Write)." },
        { "type": "code", "language": "bash", "code": "aws rds promote-read-replica --db-instance-identifier dr-db-01" }
      ]
    },
    {
      "title": "Verify DB Consistency",
      "content": [
        { "type": "text", "text": "Connect to DR DB and check latest transaction timestamp." },
        { "type": "code", "language": "sql", "code": "SELECT TOP 1 CreatedAt FROM Orders ORDER BY CreatedAt DESC;" }
      ]
    },
    {
      "title": "Scale Up DR Compute",
      "content": [
        { "type": "text", "text": "Increase capacity of ASG in DR region to handle full load." },
        { "type": "code", "language": "bash", "code": "aws autoscaling update-auto-scaling-group --auto-scaling-group-name dr-asg --min-size 10 --desired-capacity 10" }
      ]
    },
    {
      "title": "Update Application Config",
      "content": [
        { "type": "text", "text": "Point application connection strings to DR database endpoint." },
        { "type": "code", "language": "text", "code": "DB_HOST=dr-db-01.cxxxxx.us-west-2.rds.amazonaws.com" }
      ]
    },
    {
      "title": "Update DNS (Global Traffic Manager)",
      "content": [
        { "type": "text", "text": "Change DNS weight to send 100% traffic to DR Region." },
        { "type": "code", "language": "bash", "code": "aws route53 change-resource-record-sets ..." }
      ]
    },
    {
      "title": "Validate System Health",
      "content": [
        { "type": "text", "text": "Run synthetic smoke tests against DR endpoint." },
        { "type": "code", "language": "bash", "code": "npm run test:smoke -- --url=https://dr.example.com" }
      ]
    },
    {
      "title": "Communicate Status",
      "content": [
        { "type": "text", "text": "Update status page: 'Failed over to Secondary Region. System Operational.'" }
      ]
    }
  ]
}
